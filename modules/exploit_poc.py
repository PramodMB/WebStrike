import subprocess
import requests

def run_dalfox(urls):
    print("[*] Running dalfox for XSS...")
    results = []
    for url in urls:
        try:
            output = f"output/dalfox_{url.replace('http://', '').replace('https://', '').replace('/', '_')}.txt"
            subprocess.run(['dalfox', 'url', url, '--output', output], check=True)
            results.append(f"{url} | XSS results saved to {output}")
        except subprocess.CalledProcessError:
            results.append(f"{url} | dalfox failed")
    return results

def run_sqlmap(urls):
    print("[*] Running sqlmap in PoC mode...")
    results = []
    for url in urls:
        try:
            output = f"output/sqlmap_{url.replace('http://', '').replace('https://', '').replace('/', '_')}.txt"
            subprocess.run(['sqlmap', '-u', url, '--batch', '--crawl=1', '--random-agent',
                            '--level=2', '--risk=1', '--output-dir=output', '--flush-session',
                            '--batch', '--threads=3'], check=True)
            results.append(f"{url} | SQLi check completed")
        except subprocess.CalledProcessError:
            results.append(f"{url} | sqlmap failed or clean")
    return results

def run_open_redirect_check(urls):
    print("[*] Running open redirect checks...")
    results = []
    test_url = "https://evil.com"

    for url in urls:
        if "?" not in url:
            continue
        try:
            injected = url + test_url
            r = requests.get(injected, allow_redirects=False, timeout=5)
            if r.status_code in [301, 302] and test_url in r.headers.get("Location", ""):
                results.append(f"{url} -> open redirect to {test_url}")
        except:
            continue
    return results
